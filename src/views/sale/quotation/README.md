# Quotation System Documentation

ระบบใบเสนอราคาสำหรับธุรกิจเครื่องประดับ

## โครงสร้างไฟล์

```
quotation/
├── index-view.vue                    # หน้าหลัก - จัดการ state และ event
├── components/
│   ├── quotation-view.vue           # ตารางใบเสนอราคาและฟอร์มลูกค้า
│   └── search-view.vue              # ฟอร์มค้นหาสินค้าและใบเสนอราคา
└── modal/
    ├── edit-stock-view.vue          # แก้ไขสินค้า, วัตถุดิบ, ประเมินราคา
    ├── confirm-create-pdf-view.vue  # ยืนยันการสร้าง PDF
    ├── customer-search-modal.vue    # ค้นหาลูกค้าจากฐานข้อมูล (อัปเดต 2025-01-15)
    └── customer-create-modal.vue    # เพิ่มลูกค้าใหม่ (อัปเดต 2025-01-15)
```

## ฟีเจอร์หลัก

### 1. การค้นหาสินค้า (Search)
- **เลขที่ผลิต (ใหม่)**: รูปแบบ `DK-2502-00X`
- **เลขที่ผลิต (เก่า)**: รูปแบบ `AD054XX` 
- **รหัสสินค้า**: รูปแบบ `R08X50XXXL`
- **ค้นหาใบเสนอราคา**: ด้วยเลขที่ใบเสนอราคา

### 2. ตารางสินค้า (Quotation Table)

#### คอลัมน์หลัก
| คอลัมน์ | รายละเอียด | แก้ไขได้ |
|---------|------------|----------|
| รูปภาพ | แสดงรูปสินค้า 25x25px | ❌ |
| เลขที่ผลิต | เลขที่ผลิตใหม่/เก่า | ❌ |
| รหัสสินค้า | รหัสสินค้า/ProductNumber | ✅ |
| รายละเอียด | คำอธิบายสินค้า | ✅ |
| Gold (gms) | น้ำหนักทอง แยกตามประเภท | ❌ |
| Diamond (cts) | น้ำหนักเพชร พร้อมจำนวน | ❌ |
| Stone (cts) | น้ำหนักพลอย พร้อมจำนวน | ❌ |
| ราคาขาย (THB) | ราคาต้นฉบับ | ❌ |
| ราคาประเมิน (THB) | ราคาที่ใช้คำนวณ | ✅ |
| ส่วนลด (%) | ส่วนลดจากลูกค้า | ❌ |
| ราคาส่วนลด (THB) | ราคาหลังหักส่วนลด | ❌ |
| แปลงเรท | อัตราแลกเปลี่ยน | ❌ |
| ราคาแปลง | ราคาในสกุลเงินต่างประเทศ | ❌ |
| จำนวน | จำนวนสินค้า | ✅ |
| รวมราคา | ราคารวมต่อรายการ | ❌ |

#### การดำเนินการ
- **ลบ**: ลบรายการออกจากตาราง
- **แก้ไข**: เปิด Modal แก้ไขสินค้า
- **คัดลอก**: คัดลอกรายการ (ไม่รวมเลขที่ผลิต)

### 3. การคำนวณราคา

#### สูตรการคำนวณ
```javascript
// ราคาหลังส่วนลด
discountPrice = appraisalPrice × (1 - discountPercent/100)

// ราคาแปลงสกุลเงิน  
convertedPrice = discountPrice ÷ currencyMultiplier

// ราคารวมต่อรายการ
totalPrice = convertedPrice × quantity

// ราคารวมทั้งหมด
grandTotal = Σ(totalPrice) + freight
```

#### ส่วนสรุป (Footer)
- **Net Weight**: น้ำหนักสุทธิ `(diamond + gem)/5 + gold`
- **รวมทอง/เพชร/พลอย**: น้ำหนักรวมตามประเภท
- **Freight & Insurance**: ค่าขนส่งและประกัน
- **ราคารวม**: ราคาสุทธิทั้งหมด

### 4. ข้อมูลลูกค้า (Customer Information)

#### ข้อมูลพื้นฐาน
- **วันที่ใบเสนอราคา**: เลือกจากปฏิทิน
- **เลขที่ใบเสนอราคา**: กำหนดเอง

#### การจัดการข้อมูลลูกค้า (อัปเดต 2025-01-15)
**แยกเป็นส่วนต่างหาก**: ข้อมูลลูกค้าถูกแยกออกมาเป็น section แยกต่างหาก

**ระบบค้นหาและเลือกลูกค้า**:
- **ปุ่มค้นหาลูกค้า**: เปิด Modal ค้นหาลูกค้าจากฐานข้อมูล
- **ปุ่มเพิ่มลูกค้าใหม่**: เปิด Modal สำหรับเพิ่มลูกค้าใหม่

**การแสดงข้อมูล**: เปลี่ยนจากการ input เป็นการแสดงข้อมูลแบบ read-only
- **ชื่อลูกค้า**: แสดงจากการเลือกลูกค้า
- **ที่อยู่**: แสดงจากการเลือกลูกค้า
- **เบอร์โทร**: แสดงจากการเลือกลูกค้า
- **อีเมล**: แสดงจากการเลือกลูกค้า
- **หมายเหตุ**: สามารถแก้ไขได้ (เฉพาะฟิลด์นี้)

#### การตั้งค่าราคา
- **Currency**: สกุลเงิน (เช่น US$, EUR)
- **Currency Rate**: อัตราแลกเปลี่ยน (เช่น 33.0)
- **Markup**: อัตรากำไร
- **Discount (%)**: ส่วนลดให้ลูกค้า (0-100%)
- **Gold (US$/Oz.)**: ราคาทองคำอ้างอิง

### 5. การแก้ไขสินค้า (Edit Stock Modal)

#### การจัดการรูปภาพ
- **อัปโหลดรูป**: อัปโหลดไฟล์ใหม่ (บีบอัดอัตโนมัติ)
- **เลือกจากคลัง**: เลือกรูปจาก Image Gallery
- **ค้นหารูป**: ค้นหาด้วยชื่อไฟล์

#### ข้อมูลสินค้า
- **รหัสสินค้า**: Product Number
- **รายละเอียด**: คำอธิบายสินค้า

#### จัดการวัตถุดิบ (Materials)
| ประเภท | รหัส | จำนวน+หน่วย | น้ำหนัก+หน่วย | ราคา |
|--------|------|-------------|---------------|------|
| ทอง/เงิน | Gold Master | 1 pc | 5.50 ct. | 1000 |
| เพชร | Diamond Grade | 3 pc | 0.75 ct. | 2000 |
| พลอย | Gem Master | 5 pc | 2.30 ct. | 500 |

#### การประเมินราคา (Cost Calculation)
แบ่งตามประเภทงาน:
- **รายการทอง**: ต้นทุนวัตถุดิบทอง
- **รายการวัถุดิบ**: เพชร พลอย อื่นๆ
- **รายการงานช่าง**: ค่าแรงช่าง
- **รายการงานฝัง**: ค่างานฝังพลอย
- **รายการเพิ่มเติม**: ค่าใช้จ่ายอื่นๆ

```javascript
// สูตรคำนวณต้นทุน
totalCost = (qty × qtyPrice) + (weight × weightPrice)
costPerPiece = Σ(totalCost) // ต้นทุนต่อชิ้น
```

### 6. Modal การจัดการลูกค้า (อัปเดต 2025-01-15)

#### Customer Search Modal (`customer-search-modal.vue`)
**ฟีเจอร์**:
- ค้นหาลูกค้าด้วยชื่อหรือรหัสลูกค้า
- แสดงผลลัพธ์ในตาราง DataTable พร้อม pagination
- สามารถเลือกลูกค้าได้โดยการคลิกปุ่ม "เลือก"
- รองรับ sorting และ pagination

**คอลัมน์ในตาราง**:
- รหัสลูกค้า (code)
- ชื่อ TH (nameTh)
- ชื่อ EN (nameEn)
- ที่อยู่ (address)
- โทรศัพท์ (telephone1)
- E-mail (email)

#### Customer Create Modal (`customer-create-modal.vue`)
**ฟีเจอร์**:
- เพิ่มลูกค้าใหม่ในระบบ
- รองรับข้อมูลทั้งภาษาไทยและอังกฤษ
- มีการ validation สำหรับฟิลด์จำเป็น
- ใช้ SweetAlert2 สำหรับ confirmation และ success message

**ฟิลด์ข้อมูล**:
- รหัสลูกค้า (บังคับ)
- ประเภทลูกค้า (บังคับ - เลือกจาก Dropdown)
- ชื่อภาษาไทย (บังคับ)
- ชื่อภาษาอังกฤษ
- ที่อยู่ติดต่อ
- เบอร์โทรติดต่อ 1 และ 2
- E-mail
- บุคคลติดต่อ
- ข้อมูลเพิ่มเติม

### 7. การสร้าง PDF

#### ประเภท PDF
- **Quotation File**: ใบเสนอราคามาตรฐาน
- **Breakdown File**: รายละเอียดต้นทุน (ถ้ามี)

#### การตั้งค่า
- **Items per page**: จำนวนรายการต่อหน้า (1-50)
- **Save and Create**: บันทึกข้อมูลก่อนสร้าง PDF

### 7. การจัดเก็บข้อมูล

#### การบันทึก (Save Quotation)
```javascript
formValue = {
  number: invoiceNumber,
  customerName, customerAddress, customerPhone, customerEmail,
  currency, currencyRate, markup, discount,
  freight, date, remark,
  data: JSON.stringify(quotationItems) // เก็บเป็น JSON
}
```

#### การโหลด (Load Quotation)
- ค้นหาด้วยเลขที่ใบเสนอราคา
- แปลง JSON กลับเป็น Array
- populate ข้อมูลในฟอร์ม

## การใช้งาน

### 1. สร้างใบเสนอราคาใหม่
1. ค้นหาสินค้าด้วยเลขที่ผลิตหรือรหัสสินค้า
2. สินค้าจะถูกเพิ่มเข้าตารางอัตโนมัติ
3. แก้ไขราคาประเมินและจำนวนตามต้องการ
4. **เลือกลูกค้า** (อัปเดต 2025-01-15):
   - คลิก "ค้นหาลูกค้า" เพื่อเลือกจากฐานข้อมูล
   - หรือคลิก "เพิ่มลูกค้าใหม่" เพื่อสร้างลูกค้าใหม่
   - ข้อมูลลูกค้าจะถูกแสดงอัตโนมัติ
5. ตั้งค่าราคาและสกุลเงิน
6. สร้าง PDF หรือบันทึกข้อมูล

### 2. แก้ไขใบเสนอราคาเดิม
1. ค้นหาด้วยเลขที่ใบเสนอราคา
2. ระบบจะโหลดข้อมูลเดิมมาแสดง
3. แก้ไขข้อมูลตามต้องการ
4. บันทึกข้อมูลใหม่

### 3. การแก้ไขสินค้าแต่ละรายการ
1. คลิกปุ่ม "แก้ไข" ในตาราง
2. Modal จะเปิดขึ้นพร้อมข้อมูลสินค้า
3. แก้ไขรูปภาพ, รายละเอียด, วัตถุดิบ
4. ประเมินราคาใหม่ตามต้องการ
5. บันทึกการเปลี่ยนแปลง

## ข้อมูลเทคนิค

### Dependencies
- **PrimeVue**: DataTable, Calendar, Dropdown
- **Vue 3**: Composition API, Reactivity
- **Pinia Stores**: API management
- **PDF Generation**: Custom PDF integration

### API Endpoints
- `usrStockProductApiStore`: ค้นหาและแก้ไขสินค้า
- `usrQuotationApiStore`: บันทึกและโหลดใบเสนอราคา
- `stockProductImageApiStor`: จัดการรูปภาพ
- `useMasterApiStore`: ข้อมูล Master (ทอง, เพชร, พลอย)
- `useCustomerDetailApiStore`: การจัดการลูกค้า (อัปเดต 2025-01-15)
  - `fetchCustomerSearch`: ค้นหาลูกค้า
  - `fetchCreateCustomer`: เพิ่มลูกค้าใหม่

### Performance Optimizations
- **Async Components**: โหลด Modal แบบ lazy
- **Image Compression**: บีบอัดรูปก่อนอัปโหลด
- **Computed Properties**: คำนวณราคาแบบ reactive
- **Deep Watch**: ติดตาม state changes

## การบำรุงรักษา

### หากต้องการเพิ่มคอลัมน์ใหม่
1. เพิ่ม `<column>` ใน `quotation-view.vue`
2. เพิ่ม field ใน `interfaceForm`
3. อัปเดตการคำนวณใน computed properties
4. ปรับ PDF template ให้รองรับ

### หากต้องการเปลี่ยนสูตรคำนวณ
1. แก้ไข computed properties ใน `quotation-view.vue`
2. อัปเดต `onBluePrice`, `onBlueQty` methods
3. ทดสอบการคำนวณทุกกรณี

### การเพิ่ม Master Data
1. เพิ่มใน `masterMaterialType` array
2. อัปเดต dropdown options ใน `edit-stock-view.vue`
3. เพิ่ม case ใน `getBarcode()` method

## สรุปการอัปเดต 2025-01-15

### การเปลี่ยนแปลงหลัก
1. **แยก Customer Information Section**: ข้อมูลลูกค้าถูกแยกออกมาเป็นส่วนแยกต่างหาก
2. **เพิ่ม Customer Search Modal**: ระบบค้นหาลูกค้าจากฐานข้อมูล
3. **เพิ่ม Customer Create Modal**: ระบบเพิ่มลูกค้าใหม่
4. **เปลี่ยนการแสดงข้อมูลลูกค้า**: จาก input เป็น read-only display
5. **เพิ่มปุ่มจัดการลูกค้า**: ปุ่มค้นหาและเพิ่มลูกค้าใหม่

### ไฟล์ที่เพิ่มใหม่
- `modal/customer-search-modal.vue`
- `modal/customer-create-modal.vue`

### ไฟล์ที่แก้ไข
- `components/quotation-view.vue` - แยก customer section และเพิ่ม modal integration

---
*อัพเดทล่าสุด: 2025-01-15*